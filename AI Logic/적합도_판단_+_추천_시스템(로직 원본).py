# -*- coding: utf-8 -*-
"""ì í•©ë„ íŒë‹¨ + ì¶”ì²œ ì‹œìŠ¤í…œ.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1tuVc_5FGDwKWvy93amLcD42Crl_YfeOH
"""

import pandas as pd
import math
!pip install mysql-connector-python
import mysql.connector
from openai import OpenAI

# ---------------------------------------------------------
# ğŸ”¹ OpenAI API Key ì„¤ì •
# ---------------------------------------------------------
client = OpenAI(api_key="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")  # ğŸ” ë³¸ì¸ í‚¤ ì…ë ¥

# ---------------------------------------------------------
# ğŸ”¹ RDS ì—°ê²° ì„¤ì •
# ---------------------------------------------------------
RDS_HOST = "ewha-baekkot-ending.c5cq20gw2kei.ap-northeast-2.rds.amazonaws.com"
RDS_USER = "popo"
RDS_PW = "EWHA_ending25"

# ---------------------------------------------------------
# ğŸ”¹ ì‚¬ìš©ì ë° ìƒí’ˆ ì„¤ì •
# ---------------------------------------------------------
target_user_id = "1"
product_name = "ì§„ì«„ë©´ (150GX4)"

# ---------------------------------------------------------
# 1ï¸âƒ£ RDSì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
# ---------------------------------------------------------
conn = mysql.connector.connect(
    host=RDS_HOST,
    user=RDS_USER,
    password=RDS_PW,
    database="user_info_db"
)

# ğŸ”¹ SQL ì¿¼ë¦¬ (í…Œì´ë¸”: user_private)
query_user = """
SELECT user_id, allergies, medical_conditions
FROM user_private
WHERE user_id = %s
"""

user_df = pd.read_sql(query_user, conn, params=[target_user_id])
conn.close()

if user_df.empty:
    raise ValueError(f"'{target_user_id}' ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

def split_list(x):
    if x is None or (isinstance(x, float) and pd.isna(x)):
        return []
    return [t.strip() for t in str(x).replace(";", ",").split(",") if t.strip()]

user_allergies = split_list(user_df.iloc[0]["allergies"])
user_goals = split_list(user_df.iloc[0]["medical_conditions"])

# ---------------------------------------------------------
# 2ï¸âƒ£ RDSì—ì„œ ìƒí’ˆ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
# ---------------------------------------------------------
conn = mysql.connector.connect(
    host=RDS_HOST, user=RDS_USER, password=RDS_PW, database="product_db"
)
query_product = "SELECT * FROM ramen_db"
df = pd.read_sql(query_product, conn)
conn.close()

# ---------------------------------------------------------
# âš™ï¸ ìˆ«ì ë³€í™˜ ìœ í‹¸ í•¨ìˆ˜ (ì‰¼í‘œ, ë‹¨ìœ„ ì œê±°)
# ---------------------------------------------------------
def num(x):
    try:
        return float(str(x).replace(",", "")
                             .replace("mg", "")
                             .replace("g", "")
                             .replace("kcal", "")
                             .strip())
    except:
        return None

df.columns = [c.strip().replace(" ", "") for c in df.columns]

for col in df.columns:
    if any(unit in col for unit in ["mg", "g", "kcal"]):
        df[col] = df[col].apply(num)
if "ê°œë³„ë‚´ìš©ëŸ‰" in df.columns:
    df["ê°œë³„ë‚´ìš©ëŸ‰"] = df["ê°œë³„ë‚´ìš©ëŸ‰"].apply(num)

# ---------------------------------------------------------
# 3ï¸âƒ£ ì„ íƒ ì œí’ˆ ì¶”ì¶œ
# ---------------------------------------------------------
row = df[df["í’ˆëª…"] == product_name]
if row.empty:
    raise ValueError(f"'{product_name}' ì œí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
row = row.iloc[0]

# ---------------------------------------------------------
# 4ï¸âƒ£ ê±´ê°•ëª©í‘œë³„ ì„±ë¶„Â·ë°©í–¥ ë§¤í•‘
# ---------------------------------------------------------
health_condition_rules = {
    "ê³ í˜ˆì••": {"ë‚˜íŠ¸ë¥¨": "low"},
    "ë‹¹ë‡¨": {"ë‹¹ë¥˜": "low"},
    "ê°ëŸ‰": {"ì¹¼ë¡œë¦¬": "low"},
    "ê³ ì§€í˜ˆì¦": {"ì§€ë°©": "low", "í¬í™”ì§€ë°©": "low", "íŠ¸ëœìŠ¤ì§€ë°©": "low"},
    "ì‹¬í˜ˆê´€ì§ˆí™˜": {"ë‚˜íŠ¸ë¥¨": "low", "í¬í™”ì§€ë°©": "low", "ì½œë ˆìŠ¤í…Œë¡¤": "low"},
    "ì‹ ì¥ì§ˆí™˜": {"ë‚˜íŠ¸ë¥¨": "low", "ë‹¨ë°±ì§ˆ": "low"},
    "ê°„ì§ˆí™˜": {"ë‹¹ë¥˜": "low", "ì§€ë°©": "low"},
    "ê³¨ë‹¤ê³µì¦": {"ì¹¼ìŠ˜": "high", "ë‚˜íŠ¸ë¥¨": "low"},
    "ê³ ì½œë ˆìŠ¤í…Œë¡¤í˜ˆì¦": {"ì½œë ˆìŠ¤í…Œë¡¤": "low", "í¬í™”ì§€ë°©": "low"},
    "í†µí’": {"ë‹¨ë°±ì§ˆ": "low"},
}

target_map = {}
for goal in user_goals:
    if goal in health_condition_rules:
        target_map.update(health_condition_rules[goal])

if not target_map:
    target_map = {"ì¹¼ë¡œë¦¬": "low"}

# ---------------------------------------------------------
# 5ï¸âƒ£ ì•Œë ˆë¥´ê¸° ì§ì ‘ ì²´í¬
# ---------------------------------------------------------
notice = str(row.get("ì•Œë ˆë¥´ê¸°", "")).lower()
if any(a.lower() in notice for a in user_allergies):
    final = "ë¶€ì í•©"
else:
    final = "ì í•©"

# ---------------------------------------------------------
# 6ï¸âƒ£ ì„±ë¶„ë³„ í‰ê°€
# ---------------------------------------------------------
def calc_per_100(df, key):
    df_valid = df.dropna(subset=["ê°œë³„ë‚´ìš©ëŸ‰"])
    vals = []
    for _, r in df_valid.iterrows():
        try:
            vals.append(float(r.get(key, 0)) / float(r.get("ê°œë³„ë‚´ìš©ëŸ‰", 100)) * 100)
        except:
            continue
    return sum(vals) / len(vals) if vals else None

nutrition_results = []
for key, direction in target_map.items():
    try:
        value = float(row.get(key, 0))
        total = float(row.get("ê°œë³„ë‚´ìš©ëŸ‰", 100))
        per_100 = value / total * 100
    except:
        per_100 = None

    avg_value = calc_per_100(df, key)
    if value == 0 or per_100 == 0:
        status = "ë¯¸í•¨ìœ "
    elif avg_value is None or per_100 is None:
        status = "ì •ë³´ë¶€ì¡±"
    else:
        diff_ratio = per_100 / avg_value if avg_value != 0 else None
        if diff_ratio is None:
            status = "ì •ë³´ë¶€ì¡±"
        elif diff_ratio > 1.1:
            status = "í‰ê· ë³´ë‹¤ ë†’ìŒ"
        elif diff_ratio < 0.9:
            status = "í‰ê· ë³´ë‹¤ ë‚®ìŒ"
        else:
            status = "í‰ê· ê³¼ ë¹„ìŠ·í•¨"

    nutrition_results.append({
        "ì„±ë¶„": key,
        "ê°’": per_100,
        "í‰ê· ": avg_value,
        "ë°©í–¥": direction,
        "í‰ê°€": status
    })

# ---------------------------------------------------------
# 7ï¸âƒ£ ê°„ì ‘ ì•Œë ˆë¥´ê¸° ê²½ê³ 
# ---------------------------------------------------------
indirect = row.get("ê°„ì ‘ì•Œë ˆë¥´ê¸°", None)
warning_text = ""
if indirect is not None and not (isinstance(indirect, float) and math.isnan(indirect)):
    indirect_str = str(indirect).lower()
    for a in user_allergies:
        if a.lower() in indirect_str or indirect_str in ["o", "yes", "1", "true"]:
            warning_text = f"âš ï¸ '{a}' ê°„ì ‘ ì•Œë ˆë¥´ê¸° ì£¼ì˜"
            break

# ---------------------------------------------------------
# 8ï¸âƒ£ OpenAI ìš”ì•½
# ---------------------------------------------------------
try:
    nutrition_summary = ", ".join(
        [f"{n['ì„±ë¶„']}({n['í‰ê°€']}, {n['ë°©í–¥']})" for n in nutrition_results]
    )

    prompt = f"""
ì‚¬ìš©ì ì¡°ê±´:
- ì•Œë ˆë¥´ê¸°: {', '.join(user_allergies) if user_allergies else 'ì—†ìŒ'}
- ê±´ê°•ëª©í‘œ: {', '.join(user_goals)}
- ì£¼ìš” í‰ê°€ ì„±ë¶„ ë° ë°©í–¥: {nutrition_summary}

ì œí’ˆëª…: {product_name}
ìµœì¢…íŒì •(ì•Œë ˆë¥´ê¸° ê¸°ì¤€): {final}
ê²½ê³ ë¬¸êµ¬: {warning_text}

ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ìì—°ìŠ¤ëŸ½ê²Œ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì„¤ëª…í•´ì¤˜:
1. ì•Œë ˆë¥´ê¸° ê¸°ì¤€ìœ¼ë¡œ ì´ ì œí’ˆì´ ì™œ '{final}' ì¸ì§€,
2. ì‚¬ìš©ìì˜ ê±´ê°•ìƒíƒœ(ì˜ˆ: ê³ í˜ˆì••, ê°ëŸ‰ ë“±)ì™€ ì œí’ˆì˜ ì„±ë¶„ íŠ¹ì„± ê°„ì˜ ê´€ê³„.
"""
    res = client.responses.create(
        model="gpt-4.1-mini",
        input=prompt,
        temperature=0.3,
    )
    reason = res.output_text.strip()
except Exception:
    reason = "(AI ì„¤ëª… ìƒì„± ì‹¤íŒ¨)"

# ---------------------------------------------------------
# 9ï¸âƒ£ ê²°ê³¼ ì¶œë ¥
# ---------------------------------------------------------
print("ğŸ” ì œí’ˆëª…:", product_name)
print("âœ… ìµœì¢… íŒì •:", final)
print("ğŸ’¬ ì´ìœ :", reason)
if warning_text:
    print(warning_text)

print("\nğŸ“Š ì„±ë¶„ ìƒì„¸ ë¶„ì„ ê²°ê³¼:")
for n in nutrition_results:
    val = n.get("ê°’")
    val_str = f"{val:.2f}" if isinstance(val, (int, float)) and val is not None else "N/A"
    print(f"- {n['ì„±ë¶„']}: {val_str} ({n['í‰ê°€']})")

# ---------------------------------------------------------
# 11ï¸âƒ£ XGBoost + LightFM ì¶”ì²œ (ì í•©ë„ ê²°ê³¼ ê¸°ë°˜)
# ---------------------------------------------------------
from sklearn.model_selection import train_test_split
from xgboost import XGBClassifier
!pip install lightfm
from lightfm import LightFM
from lightfm.data import Dataset
import numpy as np

# ---------------------------------------------------------
# 1ï¸âƒ£ RDS ì—°ê²° â†’ product_db.ramen_db í…Œì´ë¸” ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°
# ---------------------------------------------------------
conn = mysql.connector.connect(
    host=RDS_HOST,
    user=RDS_USER,
    password=RDS_PW,
    database="product_db"
)
df = pd.read_sql("SELECT * FROM ramen_db", conn)
conn.close()

# ---------------------------------------------------------
# ğŸ¯ ê¸°ì¤€ ì œí’ˆê³¼ ìœ ì‚¬í•œ ì œí’ˆ ì¶”ì²œ
# ---------------------------------------------------------
from sklearn.metrics.pairwise import cosine_similarity
import numpy as np
import pandas as pd

# 0) í›„ë³´ í’€ ë§Œë“¤ê¸° (ì•Œë ˆë¥´ê¸° í¬í•¨ ì œí’ˆ ì œì™¸ + ë³¸ì¸ ì œí’ˆ ì œì™¸)
def has_allergy(row, allergy_list):
    text = str(row.get("ì•Œë ˆë¥´ê¸°", "")).lower()
    return any(a.lower() in text for a in allergy_list)

pool_df = df[~df.apply(lambda r: has_allergy(r, user_allergies), axis=1)].copy()
pool_df = pool_df[pool_df["í’ˆëª…"] != product_name].copy()

# 1) ìœ ì‚¬ë„ ê³„ì‚°ìš© ì˜ì–‘ì„±ë¶„ ì»¬ëŸ¼
raw_cols = ["ì—´ëŸ‰","ì¹¼ë¡œë¦¬","ë‚˜íŠ¸ë¥¨","ë‹¹ë¥˜","íƒ„ìˆ˜í™”ë¬¼","ì§€ë°©","ë‹¨ë°±ì§ˆ",
            "ì½œë ˆìŠ¤í…Œë¡¤","í¬í™”ì§€ë°©","íŠ¸ëœìŠ¤ì§€ë°©","ì¹¼ìŠ˜","ì¹´í˜ì¸"]
nutr_cols = [c for c in raw_cols if c in df.columns]

# 2) per-100 ê¸°ì¤€ ë³€í™˜
def to_per100_frame(x):
    out = {}
    total = float(x.get("ê°œë³„ë‚´ìš©ëŸ‰", 100)) or 100
    for c in nutr_cols:
        try:
            out[c] = float(x.get(c, np.nan)) / total * 100
        except:
            out[c] = np.nan
    return pd.Series(out)

row = df[df["í’ˆëª…"] == product_name].iloc[0]
base_vec = to_per100_frame(row)
pool_per100 = pool_df.apply(to_per100_frame, axis=1)

# ê²°ì¸¡ì¹˜ ë³´ì •
fill_vals = pool_per100.median()
pool_per100 = pool_per100.fillna(fill_vals)
base_vec = base_vec.fillna(fill_vals)

# 3) ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
sim = cosine_similarity([base_vec.values], pool_per100.values)[0]
pool_df = pool_df.assign(similarity=sim).sort_values("similarity", ascending=False)

# 4) ìƒìœ„ 6ê°œ ì¶œë ¥ (ê¹”ë”í•˜ê²Œ)
top6 = pool_df.head(6)
# ---------------------------------------------------------
#(ì í•©/ë¶€ì í•©ì— ë”°ë¼ ë¬¸êµ¬ ë³€ê²½)
# ---------------------------------------------------------
print("\n-----------------------------------------------------")
if final == "ë¶€ì í•©":
    print("ğŸ‘‰ ëŒ€ì‹  ì´ëŸ° ìƒí’ˆì„ ì¶”ì²œë“œë ¤ìš”:")
else:
    print("ğŸ‘‰ ì´ëŸ° ìƒí’ˆë„ í•¨ê»˜ ì¶”ì²œë“œë ¤ìš”:")
print("-----------------------------------------------------")

# âœ… ìœ ì‚¬ë„ ê¸°ë°˜ ì¶”ì²œ TOP 6 ì¶œë ¥
for i, name in enumerate(top6["í’ˆëª…"].tolist(), start=1):
    print(f"{i}. {name}")

print("-----------------------------------------------------")
